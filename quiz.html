<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Mode - Polyglot Pal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=2">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">Polyglot Pal</div>
            <ul class="sidebar-nav">
                <li><a href="dashboard.html"><i>ğŸ </i> Dashboard</a></li>
                <li><a href="translate.html"><i>ğŸ—£ï¸</i> Translate</a></li>
                <li><a href="quiz.html" class="active"><i>ğŸ“š</i> Learn</a></li>
                <li><a href="#"><i>ğŸ†</i> Leaderboard</a></li>
                <li><a href="#"><i>âš™ï¸</i> Settings</a></li>
            </ul>
            <div class="user-profile-mini">
                <div class="avatar">JD</div>
                <div class="user-info">
                    <h4>John Doe</h4>
                    <p>Free Plan</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="dashboard-header">
                <div class="welcome-text">
                    <h1>Practice Quiz</h1>
                    <p class="date-display">Test your vocabulary skills.</p>
                </div>
            </header>

            <!-- Refined Quiz Header with Language and Score -->
            <div class="quiz-top-bar"
                style="margin-top: 20px; display: flex !important; visibility: visible !important;">
                <div class="lang-selector-container"
                    style="border: 2px solid #ff0000; padding: 10px; border-radius: 8px;">
                    <label for="quizLang" style="color: white; font-weight: bold;">SELECT LANGUAGE (Debug Mode):</label>
                    <div class="select-wrapper">
                        <select id="quizLang">
                            <option value="es">Spanish ğŸ‡ªğŸ‡¸</option>
                            <option value="fr">French ğŸ‡«ğŸ‡·</option>
                            <option value="de">German ğŸ‡©ğŸ‡ª</option>
                            <option value="hi">Hindi ğŸ‡®ğŸ‡³</option>
                            <option value="te">Telugu ğŸ‡®ğŸ‡³</option>
                            <option value="ta">Tamil ğŸ‡®ğŸ‡³</option>
                            <option value="ja">Japanese ğŸ‡¯ğŸ‡µ</option>
                            <option value="ko">Korean ğŸ‡°ğŸ‡·</option>
                            <option value="zh-cn">Chinese ğŸ‡¨ğŸ‡³</option>
                        </select>
                        <i class="select-icon">â–¼</i>
                    </div>
                </div>

                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">Score</div>
                        <div class="score-value" id="scoreValue">0</div>
                    </div>
                    <div class="divider"></div>
                    <div class="score-item">
                        <div class="score-label">Progress</div>
                        <div class="score-value" id="questionCounter">1/10</div>
                    </div>
                </div>
            </div>

            <div class="quiz-container">
                <div class="quiz-card">
                    <div id="loading"
                        style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
                        Loading Question...
                    </div>

                    <div id="quizContent">
                        <div class="quiz-question" id="questionText"
                            style="font-size: 1.75rem; font-weight: 600; margin-bottom: 2rem; text-align: center;">
                            Loading...
                        </div>

                        <div class="quiz-options" id="optionsContainer">
                            <!-- Options will be injected here -->
                        </div>

                        <div class="quiz-feedback" id="feedback"></div>

                        <button class="btn btn-primary" id="nextBtn"
                            style="display: none; margin: 1.5rem auto 0; min-width: 200px;">Next
                            Question</button>
                    </div>

                    <!-- Results Screen -->
                    <div id="resultsScreen" style="display: none; text-align: center; padding: 2rem;">
                        <h2 style="font-size: 2.5rem; margin-bottom: 1rem;">ğŸ‰ Quiz Complete!</h2>
                        <div style="font-size: 3rem; font-weight: 700; color: var(--primary); margin: 1.5rem 0;">
                            <span id="finalScore">0</span>/100
                        </div>
                        <div style="font-size: 1.25rem; color: var(--text-muted); margin-bottom: 2rem;">
                            You got <span id="correctCount" style="color: var(--primary); font-weight: 600;">0</span>
                            out of 10 correct!
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                            <button class="btn btn-primary" id="playAgainBtn" style="min-width: 150px;">Play
                                Again</button>
                            <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'"
                                style="min-width: 150px;">Dashboard</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        const quizLang = document.getElementById('quizLang');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedback = document.getElementById('feedback');
        const nextBtn = document.getElementById('nextBtn');
        const loading = document.getElementById('loading');
        const quizContent = document.getElementById('quizContent');
        const scoreValue = document.getElementById('scoreValue');
        const questionCounter = document.getElementById('questionCounter');
        const resultsScreen = document.getElementById('resultsScreen');
        const finalScore = document.getElementById('finalScore');
        const correctCount = document.getElementById('correctCount');
        const playAgainBtn = document.getElementById('playAgainBtn');

        let currentCorrectAnswer = "";
        let score = 0;
        let currentQuestion = 1;
        let totalQuestions = 10;
        let correctAnswers = 0;

        // Load initial question
        loadQuestion();

        quizLang.addEventListener('change', resetQuiz);
        nextBtn.addEventListener('click', loadNextQuestion);
        playAgainBtn.addEventListener('click', resetQuiz);

        function resetQuiz() {
            score = 0;
            currentQuestion = 1;
            correctAnswers = 0;
            scoreValue.textContent = score;
            questionCounter.textContent = `${currentQuestion}/${totalQuestions}`;
            resultsScreen.style.display = 'none';
            quizContent.style.display = 'block';
            loadQuestion();
        }

        function loadNextQuestion() {
            currentQuestion++;
            if (currentQuestion > totalQuestions) {
                showResults();
            } else {
                questionCounter.textContent = `${currentQuestion}/${totalQuestions}`;
                loadQuestion();
            }
        }

        async function loadQuestion() {
            // Reset UI
            loading.style.display = 'block';
            quizContent.style.opacity = '0.5';
            feedback.textContent = '';
            feedback.className = 'quiz-feedback';
            nextBtn.style.display = 'none';
            optionsContainer.innerHTML = '';

            try {
                const response = await fetch('/api/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: quizLang.value })
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error loading quiz: ' + data.error);
                    return;
                }

                // Update UI with new question
                questionText.textContent = data.question;
                currentCorrectAnswer = data.correct_answer;

                data.options.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'option-label';

                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'quiz-option';
                    input.value = option.translated;
                    input.onchange = () => checkAnswer(label, option.translated);

                    const content = document.createElement('div');
                    content.className = 'option-content';
                    content.innerHTML = `
                        <div class="option-text">
                            ${option.translated}
                            <span class="pronunciation">${option.pronunciation || ''}</span>
                        </div>
                        <div class="option-check"></div>
                    `;

                    label.appendChild(input);
                    label.appendChild(content);
                    optionsContainer.appendChild(label);
                });

                loading.style.display = 'none';
                quizContent.style.opacity = '1';

            } catch (error) {
                console.error('Error:', error);
                loading.textContent = 'Failed to load question.';
            }
        }

        function checkAnswer(selectedLabel, selectedValue) {
            // Prevent multiple interactions
            if (nextBtn.style.display === 'block') return;

            const inputs = document.querySelectorAll('input[name="quiz-option"]');
            inputs.forEach(input => input.disabled = true);

            if (selectedValue === currentCorrectAnswer) {
                selectedLabel.classList.add('correct');
                feedback.textContent = "Correct! âœ“";
                feedback.className = 'quiz-feedback feedback-correct';

                // Confetti Effect - Green
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#4CAF50', '#8BC34A', '#CDDC39']
                });

                // Update score
                score += 10;
                correctAnswers++;
                scoreValue.textContent = score;

                // Simple animation
                scoreValue.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    scoreValue.style.transform = 'scale(1)';
                }, 200);

            } else {
                selectedLabel.classList.add('wrong');
                feedback.textContent = `Wrong. The correct answer is: ${currentCorrectAnswer}`;
                feedback.className = 'quiz-feedback feedback-wrong';

                // Confetti Effect - Red (Sad)
                confetti({
                    particleCount: 50,
                    spread: 40,
                    origin: { y: 0.6 },
                    colors: ['#F44336', '#E91E63'],
                    shapes: ['square'],
                    scalar: 0.8
                });

                // Highlight correct answer
                const labels = document.querySelectorAll('.option-label');
                labels.forEach(label => {
                    if (label.querySelector('.option-text').innerText.includes(currentCorrectAnswer)) {
                        label.classList.add('correct');
                    }
                });
            }

            nextBtn.style.display = 'block';
        }

        async function showResults() {
            quizContent.style.display = 'none';
            resultsScreen.style.display = 'block';
            finalScore.textContent = score;
            correctCount.textContent = correctAnswers;

            if (score > 50) {
                confetti({
                    particleCount: 200,
                    spread: 160,
                    origin: { y: 0.6 }
                });
            }

            // Save results to backend
            try {
                await fetch('/api/quiz/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        language: quizLang.value,
                        score: score,
                        total_questions: totalQuestions,
                        correct_answers: correctAnswers
                    })
                });
            } catch (error) {
                console.error('Error saving results:', error);
            }
        }
    </script>
</body>

</html>